<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¼”å…·æ­·ç¨‹ç”¢ç”Ÿå™¨(æ’ç‰ˆå„ªåŒ–ç‰ˆ)</title>
    
    <style>
        /* --- åŸºç¤è¨­å®š --- */
        body { font-family: "Microsoft JhengHei", sans-serif; background-color: #f3f4f6; margin: 0; padding: 20px; }
        .container { max-width: 1200px; margin: 0 auto; background: #fff; padding: 30px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        h1 { text-align: center; color: #2563eb; border-bottom: 3px solid #2563eb; padding-bottom: 15px; margin-bottom: 20px; }
        
        /* èªªæ˜å€å¡Š */
        .instructions {
            background-color: #eff6ff; 
            border-left: 5px solid #3b82f6; 
            padding: 15px 20px;
            margin-bottom: 25px;
            border-radius: 4px;
            color: #1e3a8a;
            font-size: 0.95rem;
            line-height: 1.6;
        }
        .instructions h3 { margin-top: 0; margin-bottom: 8px; font-size: 1.1rem; color: #1d4ed8; }
        .instructions ol { margin: 0; padding-left: 20px; }
        .instructions li { margin-bottom: 4px; }

        /* ç³»çµ±é¸æ“‡å€ */
        .system-selector {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 15px;
            background-color: #f8fafc;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #cbd5e1;
        }
        .radio-label { display: flex; align-items: center; cursor: pointer; font-size: 1rem; font-weight: bold; color: #334155; }
        .radio-label input { margin-right: 8px; transform: scale(1.2); }
        
        /* æ–‡å­—è²¼ä¸Šå€ */
        #paste-area {
            width: 100%;
            height: 150px;
            padding: 15px;
            border: 2px dashed #94a3b8;
            border-radius: 10px;
            font-size: 0.95rem;
            background-color: #f8fafc;
            color: #334155;
            resize: vertical;
            margin-bottom: 10px;
            box-sizing: border-box; 
        }
        #paste-area:focus { outline: none; border-color: #2563eb; background-color: #fff; }

        .btn-parse {
            width: 100%;
            padding: 12px;
            background-color: #4f46e5;
            color: white;
            font-size: 1.1rem;
            border: none;
            border-radius: 6px;
            font-weight: bold;
            cursor: pointer;
            margin-bottom: 20px;
            transition: 0.2s;
        }
        .btn-parse:hover { background-color: #4338ca; }

        /* --- æ’åºå·¥å…·åˆ— (æ¨¡ä»¿ Input Row çš„ä½ˆå±€) --- */
        .sort-toolbar {
            display: flex;
            gap: 10px; /* èˆ‡ input-row gap ä¸€è‡´ */
            padding: 0 20px 10px 20px; /* å°é½Šä¸‹æ–¹ */
            align-items: flex-end;
        }
        .sort-spacer { height: 1px; } /* ä½”ä½ç”¨ */
        
        .btn-sort { 
            width: 100%; 
            padding: 8px 5px; 
            background-color: #e2e8f0; 
            color: #475569; 
            font-size: 0.9rem; 
            border: 1px solid #cbd5e1;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
        }
        .btn-sort:hover { background-color: #cbd5e1; color: #1e293b; }

        /* --- è¼¸å…¥è¡¨æ ¼æ¨£å¼ --- */
        #input-container { counter-reset: row-counter; }

        .input-row { 
            display: flex; 
            flex-wrap: wrap; 
            gap: 10px; 
            padding: 25px 20px 20px 20px; 
            border: 1px solid #e5e7eb; 
            border-radius: 8px; 
            margin-bottom: 15px; 
            background-color: #f9fafc; 
            align-items: flex-end; 
            position: relative; 
            counter-increment: row-counter; 
            transition: all 0.3s ease;
        }

        /* é …æ¬¡ç·¨è™Ÿ */
        .input-row::before {
            content: "#" counter(row-counter);
            position: absolute;
            top: 0;
            left: 0;
            background-color: #94a3b8;
            color: white;
            font-size: 0.85rem;
            font-weight: bold;
            padding: 2px 8px;
            border-top-left-radius: 7px;
            border-bottom-right-radius: 7px;
        }

        /* éŒ¯èª¤ç‹€æ…‹ç‰¹æ•ˆ */
        .input-row.error-highlight {
            border: 2px solid #ef4444 !important; 
            background-color: #fef2f2 !important; 
            box-shadow: 0 0 10px rgba(239, 68, 68, 0.2);
            animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both; 
        }
        @keyframes shake {
            10%, 90% { transform: translate3d(-1px, 0, 0); }
            20%, 80% { transform: translate3d(2px, 0, 0); }
            30%, 50%, 70% { transform: translate3d(-4px, 0, 0); }
            40%, 60% { transform: translate3d(4px, 0, 0); }
        }

        /* --- æ¬„ä½å¯¬åº¦å®šç¾© (ç¢ºä¿ä¸Šä¸‹å°é½Š) --- */
        .field-box { display: flex; flex-direction: column; }
        
        /* 1. ç§»å‹•å€ (æœ€å·¦é‚Š) */
        .box-move { flex: 0 0 60px; } 
        /* 2. ç®¡é“ */
        .box-channel { flex: 0 0 120px; }
        /* 3. æ—¥æœŸ */
        .box-date { flex: 0 0 160px; }
        /* 4. é …ç›® (è‡ªé©æ‡‰) */
        .box-item { flex: 1; min-width: 150px; }
        /* 5. æœŸé™ */
        .box-expiry { flex: 0 0 140px; }
        /* 6. å‚™è¨» */
        .box-note { flex: 0 0 100px; }
        /* 7. åˆªé™¤ (æœ€å³é‚Š) */
        .box-del { flex: 0 0 40px; }

        label { font-size: 0.85rem; font-weight: bold; color: #64748b; margin-bottom: 5px; }
        .label-rental { color: #d97706 !important; } 

        input, select { width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 6px; box-sizing: border-box; font-size: 1rem; height: 38px; }
        input:focus, select:focus { border-color: #2563eb; outline: 2px solid #93c5fd; }

        /* ç§»å‹•æŒ‰éˆ•ç¾¤çµ„ (å·¦å³æ’åˆ—) */
        .move-group {
            display: flex;
            gap: 2px;
            width: 100%;
        }
        .btn-move {
            flex: 1;
            padding: 0;
            height: 38px;
            background-color: #fff;
            color: #64748b;
            border: 1px solid #cbd5e1;
            font-size: 1.2rem;
            cursor: pointer;
            transition: 0.2s;
        }
        .btn-move:first-child { border-top-left-radius: 6px; border-bottom-left-radius: 6px; }
        .btn-move:last-child { border-top-right-radius: 6px; border-bottom-right-radius: 6px; }
        .btn-move:hover { background-color: #f1f5f9; color: #0f172a; border-color: #94a3b8; z-index: 1; }

        /* åˆªé™¤æŒ‰éˆ• */
        .btn-del { 
            width: 100%; height: 38px; 
            background-color: #fee2e2; color: #dc2626; border: 1px solid #fecaca; 
            border-radius: 6px; cursor: pointer; font-size: 1rem; 
        }
        .btn-del:hover { background-color: #fecaca; }

        /* åº•éƒ¨æŒ‰éˆ•å€ */
        .btn-group { display: flex; justify-content: center; gap: 15px; margin: 30px 0; padding-bottom: 20px; border-bottom: 1px solid #e5e7eb; }
        .btn-main { padding: 12px 25px; color: white; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; font-size: 1rem; }
        .btn-add { background-color: #2563eb; }
        .btn-gen { background-color: #059669; }
        .btn-reset { background-color: #64748b; }

        textarea.output-box { width: 100%; height: 180px; padding: 15px; border: 2px solid #cbd5e1; border-radius: 8px; font-size: 1.1rem; font-family: monospace; background-color: #f1f5f9; box-sizing: border-box; }
        
        @media (max-width: 900px) { 
            .sort-toolbar { display: none; } /* æ‰‹æ©Ÿç‰ˆéš±è—æ’åºæ¢ï¼Œå¤ªæ“  */
            .input-row { flex-direction: column; align-items: stretch; gap: 10px; } 
            .box-move, .box-channel, .box-date, .box-expiry, .box-note, .box-del { flex: auto; } 
            .move-group { margin-bottom: 10px; }
        }
    </style>
</head>
<body>

<div class="container">
    <h1>æ­·ç¨‹ç”¢ç”Ÿå™¨</h1>
    
    <div class="instructions">
        <h3>ğŸ“Œ ä½¿ç”¨èªªæ˜ï¼š</h3>
        <ol>
            <li>æ­·ç¨‹ç”¢ç”Ÿå™¨å¯é€éè¤‡è£½æ•´æ¬„è¡¨æ ¼è§£æè¼¸å…¥æˆ–è‡ªè¡Œå¡«å…¥æ¬„ä½è³‡æ–™ç”¢å‡ºå½™æ•´æ–‡å­—ã€‚</li>
            <li>è«‹ä¾æ“šè¤‡è£½çš„æ¬„ä½æ ¼å¼æ˜¯ä¾†è‡ªå“ªå€‹ç³»çµ±åšé¸æ“‡å†é€²è¡Œè§£æã€‚</li>
            <li>ç³»çµ±é è¨­æœƒä¾ç…§<b>ã€Œæ—¥æœŸå…ˆå¾Œã€</b>è‡ªå‹•æ’åºè§£æå¾Œçš„è³‡æ–™ã€‚</li>
            <li>æ‚¨å¯ä»¥ä½¿ç”¨å·¦å´çš„ â¬†ï¸ â¬‡ï¸ æŒ‰éˆ•èª¿æ•´é †åºï¼Œæˆ–ä½¿ç”¨ä¸Šæ–¹çš„æ’åºæŒ‰éˆ•ã€‚</li>
            <li>è‹¥æœ‰æ ¸å®šæ—¥ç³»çµ±æœƒè‡ªå‹•å„ªå…ˆæŠ“å–æ ¸å®šæ—¥è€Œä¸æ˜¯ç”³è«‹æ—¥ã€‚</li>
            <li>ç®¡é“é¸æ“‡é•·ç…§æˆ–é•·ç…§ç§Ÿè³ƒæœƒè‡ªå‹•è¨ˆç®—æœ‰æ•ˆæœŸé™ï¼Œä½†éœ€è¦æ–‡å­—è·Ÿç³»çµ±ä¸Šä¸€æ¨¡ä¸€æ¨£ï¼Œå¦å¤–éœ€è¦è‡ªè¡Œå°‡ã€Œç”³è«‹/æ ¸å®šæ—¥/è³¼è²·æ—¥ã€æ¬„ä½çš„æ—¥æœŸæ”¹æˆè³¼è²·æ—¥æ‰æœƒè·‘å‡ºæ­£ç¢ºçš„æœ‰æ•ˆæœŸé™ã€‚</li>
            <li>é€éè§£æç›®å‰ç®¡é“åƒ…èƒ½åˆ†åˆ¥å‡ºé•·ç…§ã€é€€è¼”ã€èº«éšœã€å¥ä¿ã€‚å…¶ä»–è«‹è‡ªè¡Œæ‰‹å‹•ä¿®æ­£ã€‚</li>
        </ol>
    </div>

    <div class="system-selector">
        <label class="radio-label">
            <input type="radio" name="systemType" value="LTC" checked> é•·ç…§ç³»çµ±
        </label>
        <label class="radio-label">
            <input type="radio" name="systemType" value="DIS"> èº«éšœç³»çµ±
        </label>
    </div>

    <textarea id="paste-area" placeholder="è«‹å°‡ç³»çµ±è¡¨æ ¼çš„å…§å®¹é¸å–è¤‡è£½ (Ctrl+C)ï¼Œä¸¦åœ¨æ­¤è²¼ä¸Š (Ctrl+V)"></textarea>
    
    <button class="btn-parse" onclick="handleParse()">âš¡ é–‹å§‹è§£æä¸¦å¡«å…¥</button>

    <div class="sort-toolbar">
        <div class="box-move"></div> <div class="box-channel">
            <button class="btn-sort" onclick="sortRows('channel')">ğŸ“‚ ä¾ç®¡é“</button>
        </div>
        <div class="box-date">
            <button class="btn-sort" onclick="sortRows('date')">ğŸ“… ä¾æ—¥æœŸ</button>
        </div>
        <div class="box-item"></div> <div class="box-expiry"></div> <div class="box-note"></div> <div class="box-del"></div> </div>

    <div id="input-container">
        </div>

    <div class="btn-group">
        <button class="btn-main btn-add" onclick="addRow()">ï¼‹ æ–°å¢ä¸€ç­†</button>
        <button class="btn-main btn-gen" onclick="generateOutput()">ç”¢å‡ºå½™æ•´æ–‡å­—</button>
        <button class="btn-main btn-reset" onclick="resetForm()">å…¨éƒ¨æ¸…ç©º</button>
    </div>

    <div class="output-section">
        <h3>å½™æ•´çµæœï¼š</h3>
        <textarea id="output" class="output-box" placeholder="æŒ‰ä¸‹ã€Œç”¢å‡ºå½™æ•´æ–‡å­—ã€å¾Œï¼Œçµæœæœƒé¡¯ç¤ºåœ¨é€™è£¡..."></textarea>
    </div>
</div>

<script>
    // é•·ç…§å¹´é™è¡¨
    const rawCsvData = `
é¦¬æ¡¶å¢é«˜å™¨	3
ä¾¿ç›†æ¤…	3
æ²æµ´æ¤…	3
å–®æ”¯æ´æ–-ä¸éŠ¹é‹¼è£½	5
å–®æ”¯æ´æ–-é‹è£½	3
åŠ©è¡Œå™¨	3
å¸¶è¼ªå‹åŠ©æ­¥è»Š(åŠ©è¡Œæ¤…)	3
è¼ªæ¤…-Aæ¬¾(éè¼•é‡åŒ–é‡ç”¢å‹)	3
è¼ªæ¤…-Bæ¬¾(è¼•é‡åŒ–é‡ç”¢å‹)	3
è¼ªæ¤…-Cæ¬¾(é‡èº«è¨‚è£½å‹)	3
è¼ªæ¤…é™„åŠ åŠŸèƒ½-Aæ¬¾ï¼ˆå…·åˆ©æ–¼ç§»ä½åŠŸèƒ½ï¼‰	3
è¼ªæ¤…é™„åŠ åŠŸèƒ½-Bæ¬¾ï¼ˆå…·ä»°èººåŠŸèƒ½ï¼‰	3
è¼ªæ¤…é™„åŠ åŠŸèƒ½-Cæ¬¾ï¼ˆå…·ç©ºä¸­å‚¾å€’åŠŸèƒ½ï¼‰	3
æ“ºä½ç³»çµ±-Aæ¬¾ï¼ˆå¹³é¢å‹è¼ªæ¤…èƒŒé ï¼‰	3
æ“ºä½ç³»çµ±-Bæ¬¾ï¼ˆæ›²é¢é©å½¢è¼ªæ¤…èƒŒé ï¼‰	3
æ“ºä½ç³»çµ±-Cæ¬¾ï¼ˆè¼ªæ¤…è»€å¹¹å´æ”¯æ’æ¶ï¼‰	3
æ“ºä½ç³»çµ±-Dæ¬¾ï¼ˆè¼ªæ¤…é ­é ç³»çµ±ï¼‰	3
ç§»ä½è…°å¸¶	3
ç§»ä½æ¿	5
äººåŠ›ç§»ä½åŠå¸¶	3
ç§»ä½æ»‘å¢Š-Aæ¬¾	5
ç§»ä½æ»‘å¢Š-Bæ¬¾	5
ç§»ä½è½‰ç›¤	3
ç§»ä½æ©Ÿ	10
ç§»ä½æ©ŸåŠå¸¶	3
é›»è©±æ“´éŸ³å™¨	5
é›»è©±é–ƒå…‰éœ‡å‹•å™¨	5
ç«è­¦é–ƒå…‰è­¦ç¤ºå™¨	5
é–€éˆ´é–ƒå…‰å™¨	5
ç„¡ç·šéœ‡å‹•è­¦ç¤ºå™¨	5
è¡£è‘—ç”¨è¼”å…·	3
å±…å®¶ç”¨ç”Ÿæ´»è¼”å…·	3
é£²é£Ÿç”¨è¼”å…·	3
æ°£å¢ŠåºŠ-Aæ¬¾	3
æ°£å¢ŠåºŠ-Bæ¬¾	3
è¼ªæ¤…åº§å¢Š-Aæ¬¾ï¼ˆé€£é€šç®¡å‹æ°£å›Šæ°£å¢Šåº§-å¡‘è† æè³ªï¼‰	2
è¼ªæ¤…åº§å¢Š-Bæ¬¾ï¼ˆé€£é€šç®¡å‹æ°£å›Šæ°£å¢Šåº§-æ©¡è† æè³ªï¼‰	2
è¼ªæ¤…åº§å¢Š-Cæ¬¾ï¼ˆæ¶²æ…‹å‡è† åº§å¢Šï¼‰	2
è¼ªæ¤…åº§å¢Š-Dæ¬¾ï¼ˆå›ºæ…‹å‡è† åº§å¢Šï¼‰	5
è¼ªæ¤…åº§å¢Š-Eæ¬¾ï¼ˆå¡«å……å¼æ°£å›Šæ°£å¢Šåº§ï¼‰	5
è¼ªæ¤…åº§å¢Š-Fæ¬¾ï¼ˆäº¤æ›¿å……æ°£å‹åº§å¢Šï¼‰	3
è¼ªæ¤…åº§å¢Š-Gæ¬¾ï¼ˆé‡è£½å‹åº§å¢Šï¼‰	3
å±…å®¶ç”¨ç…§é¡§åºŠ	5
å±…å®¶ç”¨ç…§é¡§åºŠ-é™„åŠ åŠŸèƒ½Aæ¬¾ï¼ˆåºŠé¢å‡é™åŠŸèƒ½ï¼‰	5
å±…å®¶ç”¨ç…§é¡§åºŠ-é™„åŠ åŠŸèƒ½Bæ¬¾ï¼ˆé›»å‹•å‡é™åŠŸèƒ½ï¼‰	5
å±…å®¶ç„¡éšœç¤™ç’°å¢ƒæ”¹å–„-æ‰¶æ‰‹(1å–®ä½10å…¬åˆ†)	10
å±…å®¶ç„¡éšœç¤™ç’°å¢ƒæ”¹å–„-å¯å‹•å¼æ‰¶æ‰‹	10
å±…å®¶ç„¡éšœç¤™è¨­æ–½-éå›ºå®šå¼æ–œå¡æ¿ A æ¬¾	10
å±…å®¶ç„¡éšœç¤™è¨­æ–½-éå›ºå®šå¼æ–œå¡æ¿ B æ¬¾	10
å±…å®¶ç„¡éšœç¤™è¨­æ–½-éå›ºå®šå¼æ–œå¡æ¿ C æ¬¾	10
å±…å®¶ç„¡éšœç¤™è¨­æ–½-å›ºå®šå¼æ–œå¡é“	10
å±…å®¶ç„¡éšœç¤™è¨­æ–½-æ¶é«˜å¼å’Œå¼åœ°æ¿æ‹†é™¤	10
å±…å®¶ç„¡éšœç¤™è¨­æ–½-åå…‰è²¼æ¢æˆ–æ¶ˆå…‰	3
å±…å®¶ç„¡éšœç¤™è¨­æ–½-éš”é–“	10
å±…å®¶ç„¡éšœç¤™è¨­æ–½-é˜²æ»‘æªæ–½	10
å±…å®¶ç„¡éšœç¤™è¨­æ–½-é–€ A æ¬¾	10
å±…å®¶ç„¡éšœç¤™è¨­æ–½-é–€ B æ¬¾	10
å±…å®¶ç„¡éšœç¤™è¨­æ–½-æ°´é¾é ­	10
å±…å®¶ç„¡éšœç¤™è¨­æ–½-æ”¹å–„æµ´ç¼¸ï¼ˆæ–°å¢ã€æ”¹æ›ã€ç§»é™¤ï¼‰	10
å±…å®¶ç„¡éšœç¤™è¨­æ–½-æ”¹å–„æ´—è‡‰å°ï¼ˆæ§½ï¼‰ï¼ˆæ–°å¢ã€æ”¹æ›ã€ç§»é™¤ï¼‰	10
å±…å®¶ç„¡éšœç¤™è¨­æ–½-æ”¹å–„é¦¬æ¡¶ï¼ˆæ–°å¢ã€æ”¹æ›ã€ç§»é™¤ï¼‰	10
å±…å®¶ç„¡éšœç¤™è¨­æ–½-å£æ›å¼æ·‹æµ´æ¤…ï¼ˆåºŠï¼‰	10
å±…å®¶ç„¡éšœç¤™è¨­æ–½-æ”¹å–„æµç†å°ï¼ˆæ–°å¢ã€æ”¹æ›ï¼‰	10
å±…å®¶ç„¡éšœç¤™è¨­æ–½-æ”¹å–„æŠ½æ²¹ç…™æ©Ÿï¼ˆä½ç½®èª¿æ•´ï¼‰	10
å±…å®¶ç„¡éšœç¤™è¨­æ–½-ç‰¹æ®Šç°¡æ˜“æ´—æ§½	10
å±…å®¶ç„¡éšœç¤™è¨­æ–½-ç‰¹æ®Šç°¡æ˜“æµ´æ§½	10
`; 
    let deviceLifeMap = {};
    (function parseCsv() {
        const lines = rawCsvData.trim().split('\n');
        lines.forEach(line => {
            let parts = line.split(/[,\t\s]+/); 
            if (parts.length >= 2) {
                const years = parseInt(parts[parts.length - 1]);
                const name = parts.slice(0, parts.length - 1).join('');
                if (!isNaN(years) && name) { deviceLifeMap[name] = years; }
            }
        });
    })();

    // ==========================================
    //  â˜… åˆå§‹åŒ– â˜…
    // ==========================================
    window.onload = function() {
        // é è¨­å…ˆåŠ ä¸€ç­†
        addRow();
    };

    // ==========================================
    //  â˜… è§£ææ ¸å¿ƒé‚è¼¯ â˜…
    // ==========================================

    function handleParse() {
        const textArea = document.getElementById('paste-area');
        const text = textArea.value;
        const systemType = document.querySelector('input[name="systemType"]:checked').value;

        if(!text.trim()) {
            alert("è«‹å…ˆè²¼ä¸Šæ–‡å­—ï¼");
            return;
        }

        clearAllErrors();
        const lines = text.split('\n');
        let parsedData = [];

        if (systemType === 'LTC') {
            parsedData = parseLongTermCare(lines);
        } else {
            parsedData = parseDisability(lines);
        }

        if (parsedData.length > 0) {
            // è§£æå¾Œè‡ªå‹•ä¾æ—¥æœŸæ’åº
            parsedData.sort((a, b) => {
                return parseDateValue(a.date) - parseDateValue(b.date);
            });

            fillData(parsedData);
            alert(`æˆåŠŸè§£æ ${parsedData.length} ç­†è³‡æ–™ï¼(å·²è‡ªå‹•ä¾æ—¥æœŸæ’åº)`);
            textArea.value = "";
        } else {
            alert("âš ï¸ æ‰¾ä¸åˆ°æœ‰æ•ˆè³‡æ–™ï¼è«‹ç¢ºèªè¤‡è£½ä¾†æºèˆ‡é¸æ“‡ç³»çµ±æ˜¯å¦æ­£ç¢ºã€‚");
        }
    }

    function parseDateValue(dateStr) {
        if (!dateStr) return 0;
        return parseInt(dateStr.replace(/\//g, '')) || 0;
    }

    // --- 1. é•·ç…§ç³»çµ±è§£æ ---
    function parseLongTermCare(lines) {
        let results = [];
        lines.forEach(line => {
            let cols = line.split('\t');
            if (cols.length < 5) return; 

            let rawItem = cols[1] ? cols[1].trim() : "";
            let rawUnit = cols[2] ? cols[2].trim() : "";
            let rawExpiry = cols[3] ? cols[3].trim() : "";
            let rawDateApprove = cols[4] ? cols[4].trim() : ""; 
            let rawDateFund = cols[5] ? cols[5].trim() : "";    

            let finalDate = "";
            let needNote = false;

            if (isValidDate(rawDateFund)) {
                finalDate = formatDate(rawDateFund);
            } else if (isValidDate(rawDateApprove)) {
                finalDate = formatDate(rawDateApprove);
                needNote = true; 
            } else {
                return; 
            }

            let channel = "é•·ç…§"; 
            if (rawUnit === "é•·ç…§è¼”å…·") channel = "é•·ç…§";
            else if (rawUnit === "ç”Ÿæ´»è¼”å…·") channel = "èº«éšœ";
            else if (rawUnit === "é†«ç™‚è¼”å…·") channel = "é†«ç™‚";
            else if (rawUnit === "é€€è¼”æœƒ") channel = "é€€è¼”";
            else if (rawUnit === "è‡ºå—å¸‚æ¦®æ°‘æœå‹™è™•") channel = "é€€è¼”";

            let expiry = isValidDate(rawExpiry) ? formatDate(rawExpiry) : "";

            results.push({
                channel: channel,
                date: finalDate,
                item: rawItem,
                expiry: expiry,
                note: needNote ? "æ ¸å®š" : ""
            });
        });
        return results;
    }

    // --- 2. èº«éšœç³»çµ±è§£æ ---
    function parseDisability(lines) {
        let results = [];
        lines.forEach(line => {
            let cols = line.split('\t');
            if (cols.length < 8) return;

            let rawDateApprove = cols[6] ? cols[6].trim() : ""; 
            if (!isValidDate(rawDateApprove)) return;

            let finalDate = formatDate(rawDateApprove);
            let rawItem = cols[3] ? cols[3].trim() : "";     
            let rawExpiry = cols[4] ? cols[4].trim() : "";   
            let rawDateFund = cols[7] ? cols[7].trim() : "";    
            let rawUnit = cols[9] ? cols[9].trim() : "";     

            if (!isValidDate(rawDateApprove) && !isValidDate(rawDateFund)) return;

            let note = "";
            let channel = "èº«éšœ"; 

            if (isValidDate(rawDateFund)) {
                finalDate = formatDate(rawDateFund);
            } else {
                finalDate = formatDate(rawDateApprove);
                note = "æ ¸å®š"; 
            }

            if (rawUnit === "è¡›ç”Ÿç¦åˆ©éƒ¨ä¸­å¤®å¥åº·ä¿éšªç½²") {
                channel = "å¥ä¿";
            } else if (rawUnit === "è‡ºå—å¸‚æ¦®æ°‘æœå‹™è™•") {
                channel = "é€€è¼”";
            } else if (rawUnit === "è‡ºå—å¸‚æ”¿åºœ") {
                if (isValidDate(rawDateFund) && !isValidDate(rawExpiry)) {
                    channel = "é•·ç…§";
                } else {
                    channel = "èº«éšœ";
                }
            }

            let expiry = isValidDate(rawExpiry) ? formatDate(rawExpiry) : "";

            results.push({
                channel: channel,
                date: finalDate,
                item: rawItem,
                expiry: expiry,
                note: note
            });
        });
        return results;
    }

    function isValidDate(str) {
        if (!str) return false;
        let clean = str.replace(/[^\d]/g, '');
        return clean.length >= 6;
    }

    function formatDate(str) {
        if(!str) return "";
        let clean = str.trim().replace(/[.\-]/g, '/').replace(/å¹´|æœˆ/g, '/').replace(/æ—¥/g, '');
        
        if (clean.match(/^\d{6,8}$/)) {
            if (clean.length === 7) { 
                clean = `${clean.substring(0,3)}/${clean.substring(3,5)}/${clean.substring(5,7)}`;
            } else if (clean.length === 6) { 
                clean = `${clean.substring(0,2)}/${clean.substring(2,4)}/${clean.substring(4,6)}`;
            } else if (clean.length === 8) { 
                clean = `${clean.substring(0,4)}/${clean.substring(4,6)}/${clean.substring(6,8)}`;
            }
        }

        let parts = clean.split('/');
        parts = parts.filter(p => p.trim() !== "");
        
        if (parts.length === 3) {
            let y = parseInt(parts[0]);
            let m = parts[1];
            let d = parts[2];
            if (y > 1911) { y = y - 1911; }
            m = m.toString().padStart(2, '0');
            d = d.toString().padStart(2, '0');
            return `${y}/${m}/${d}`;
        }
        return clean;
    }

    function fillData(dataList) {
        // å…ˆæ¸…ç©ºï¼Œåªç•™ä¸€å€‹ç©ºç™½çš„
        const container = document.getElementById('input-container');
        container.innerHTML = '';
        addRow(); // åŠ ä¸€å€‹ä¹¾æ·¨çš„ï¼Œé›–ç„¶é¦¬ä¸Šæœƒè¢«å¡«å…¥ï¼Œä½†ç¢ºä¿çµæ§‹æ­£ç¢º

        const rows = container.querySelectorAll('.input-row');
        let targetRow = rows[0];

        dataList.forEach((data, index) => {
            if (index > 0) {
                addRow();
                const newRows = container.querySelectorAll('.input-row');
                targetRow = newRows[newRows.length - 1];
            }

            targetRow.querySelector('.channel').value = data.channel;
            handleChannelChange(targetRow.querySelector('.channel')); 

            targetRow.querySelector('.date-apply').value = data.date;
            targetRow.querySelector('.item').value = data.item;
            
            if (data.expiry) {
                targetRow.querySelector('.date-expiry').value = data.expiry;
            } else if (data.note) {
                targetRow.querySelector('.note').value = data.note;
                clearExpiry(targetRow.querySelector('.note'));
            } else {
                if (data.channel === "é•·ç…§") {
                    autoCalc(targetRow.querySelector('.item'));
                }
            }
        });
    }

    // ==========================================
    //  â˜… æ’åºèˆ‡ç§»å‹•åŠŸèƒ½ â˜…
    // ==========================================

    function moveRow(btn, direction) {
        const row = btn.closest('.input-row');
        const container = document.getElementById('input-container');
        
        if (direction === -1) { // ä¸Šç§»
            const prevRow = row.previousElementSibling;
            if (prevRow) {
                container.insertBefore(row, prevRow);
            }
        } else { // ä¸‹ç§»
            const nextRow = row.nextElementSibling;
            if (nextRow) {
                container.insertBefore(nextRow, row);
            }
        }
    }

    function sortRows(criteria) {
        const container = document.getElementById('input-container');
        const rows = Array.from(container.querySelectorAll('.input-row'));

        // æ’é™¤ç©ºè¡Œ (æ²’æœ‰æ—¥æœŸæˆ–é …ç›®çš„è¡Œä¸åƒèˆ‡æ’åºï¼Œæˆ–è€…æ’åˆ°æœ€å¾Œ)
        rows.sort((a, b) => {
            if (criteria === 'date') {
                const dateA = parseDateValue(a.querySelector('.date-apply').value);
                const dateB = parseDateValue(b.querySelector('.date-apply').value);
                return dateA - dateB;
            } else if (criteria === 'channel') {
                const chA = a.querySelector('.channel').value;
                const chB = b.querySelector('.channel').value;
                return chA.localeCompare(chB); 
            }
        });

        rows.forEach(row => container.appendChild(row));
    }

    // ==========================================
    //  â˜… ä»‹é¢èˆ‡è¨ˆç®—é‚è¼¯ (æ›´æ–°ç‰ˆHTML) â˜…
    // ==========================================
    function addRow() {
        const container = document.getElementById('input-container');
        const div = document.createElement('div');
        div.className = 'input-row';
        div.innerHTML = `
            <div class="field-box box-move">
                <label>é †åº</label>
                <div class="move-group">
                    <button class="btn-move" onclick="moveRow(this, -1)" title="ä¸Šç§»">â¬†</button>
                    <button class="btn-move" onclick="moveRow(this, 1)" title="ä¸‹ç§»">â¬‡</button>
                </div>
            </div>
            <div class="field-box box-channel">
                <label>ç®¡é“</label>
                <select class="channel" onchange="handleChannelChange(this)">
                    <option value="èº«éšœ">èº«éšœ</option>
                    <option value="é•·ç…§" selected>é•·ç…§</option>
                    <option value="é•·ç…§ç§Ÿè³ƒ">é•·ç…§ç§Ÿè³ƒ</option>
                    <option value="é†«ç™‚">é†«ç™‚</option>
                    <option value="é€€è¼”">é€€è¼”</option>
                    <option value="è·ç½">è·ç½</option>
                    <option value="å¥ä¿">å¥ä¿</option>
                </select>
            </div>
            <div class="field-box box-date">
                <label class="label-date">ç”³è«‹/æ ¸å®šæ—¥/è³¼è²·æ—¥</label>
                <input type="text" class="date-apply" placeholder="ä¾‹: 110/08/22" onblur="autoCalc(this)">
            </div>
            <div class="field-box box-item">
                <label>è¼”å…·é …ç›®</label>
                <input type="text" class="item" placeholder="è²¼ä¸Šé …ç›®åç¨±..." onblur="autoCalc(this)">
            </div>
            <div class="field-box box-expiry">
                <label class="label-expiry">æœ‰æ•ˆæœŸé™</label>
                <input type="text" class="date-expiry" placeholder="è‡ªå‹•è¨ˆç®—" onblur="formatDateInput(this)" onclick="removeError(this)">
            </div>
            <div class="field-box box-note">
                <label>æœªæ ¸éŠ·å‚™è¨»</label>
                <select class="note" onchange="clearExpiry(this); removeError(this);">
                    <option value="">(ç„¡)</option>
                    <option value="æ ¸å®š">æ ¸å®š</option>
                    <option value="ç”³è«‹">ç”³è«‹</option>
                </select>
            </div>
            <div class="field-box box-del">
                <label style="visibility: hidden;">åˆª</label>
                <button class="btn-del" onclick="removeRow(this)" title="åˆªé™¤">âœ•</button>
            </div>
        `;
        container.appendChild(div);
        
        // æ–°å¢æ™‚ï¼ŒåŒæ­¥ä¸Šä¸€åˆ—çš„ç®¡é“è¨­å®š
        const rows = document.querySelectorAll('.input-row');
        if (rows.length > 1) {
             const prevRow = rows[rows.length - 2];
             const prevVal = prevRow.querySelector('.channel').value;
             const currSel = div.querySelector('.channel');
             currSel.value = prevVal;
             handleChannelChange(currSel);
        } else {
             handleChannelChange(div.querySelector('.channel'));
        }
    }

    function removeRow(btn) {
        const row = btn.closest('.input-row');
        const container = document.getElementById('input-container');
        if (container.children.length > 1) { row.remove(); }
        else { 
            row.querySelectorAll('input').forEach(i => i.value = ''); 
            row.querySelectorAll('select').forEach(s => s.selectedIndex = 1);
            handleChannelChange(row.querySelector('.channel'));
            row.classList.remove('error-highlight');
        }
    }

    function handleChannelChange(selectElement) {
        const row = selectElement.closest('.input-row');
        const labelDate = row.querySelector('.label-date');
        const labelExpiry = row.querySelector('.label-expiry');
        const val = selectElement.value;
        if (val === 'é•·ç…§ç§Ÿè³ƒ') {
            labelDate.innerText = 'ç§Ÿè³ƒèµ·æ—¥';
            labelExpiry.innerText = 'ç§Ÿè³ƒè¿„æ—¥';
            labelDate.classList.add('label-rental');
            labelExpiry.classList.add('label-rental');
        } else {
            labelDate.innerText = 'ç”³è«‹/æ ¸å®šæ—¥/è³¼è²·æ—¥';
            labelExpiry.innerText = 'æœ‰æ•ˆæœŸé™';
            labelDate.classList.remove('label-rental');
            labelExpiry.classList.remove('label-rental');
        }
        autoCalc(selectElement);
    }

    function clearExpiry(selectElement) {
        const row = selectElement.closest('.input-row');
        const expiryInput = row.querySelector('.date-expiry');
        if (selectElement.value !== "") { 
            expiryInput.value = ""; 
        }
    }
    
    function removeError(element) {
        const row = element.closest('.input-row');
        row.classList.remove('error-highlight');
    }
    
    function clearAllErrors() {
        document.querySelectorAll('.error-highlight').forEach(el => el.classList.remove('error-highlight'));
    }

    function autoCalc(element) {
        const row = element.closest('.input-row');
        
        const noteVal = row.querySelector('.note').value;
        if (noteVal !== "") return;

        const channelInput = row.querySelector('.channel');
        const dateInput = row.querySelector('.date-apply');
        const itemInput = row.querySelector('.item');
        const expiryInput = row.querySelector('.date-expiry');

        if (element.classList.contains('date-apply')) { element.value = formatDate(element.value); }
        const dateStr = dateInput.value.trim();
        if (!dateStr) return;
        let parts = dateStr.split('/');
        if (parts.length !== 3) return;
        let rocYear = parseInt(parts[0]);
        let month = parseInt(parts[1]);
        let day = parseInt(parts[2]);
        let westernYear = rocYear + 1911;
        let startDate = new Date(westernYear, month - 1, day);
        if (channelInput.value === 'é•·ç…§ç§Ÿè³ƒ') {
            startDate.setFullYear(startDate.getFullYear() + 1);
            startDate.setDate(startDate.getDate() - 1);
            expiryInput.value = dateToROCStr(startDate);
        } else if (channelInput.value === 'é•·ç…§') {
            const itemName = itemInput.value.trim();
            if (!itemName) return;
            let yearsToAdd = 0;
            const sortedKeys = Object.keys(deviceLifeMap).sort((a, b) => b.length - a.length);
            for (const key of sortedKeys) {
                if (itemName.includes(key)) { yearsToAdd = deviceLifeMap[key]; break; }
            }
            if (yearsToAdd > 0) {
                startDate.setFullYear(startDate.getFullYear() + yearsToAdd);
                expiryInput.value = dateToROCStr(startDate);
            }
        }
    }

    function dateToROCStr(dateObj) {
        let y = dateObj.getFullYear() - 1911;
        let m = (dateObj.getMonth() + 1).toString().padStart(2, '0');
        let d = dateObj.getDate().toString().padStart(2, '0');
        return `${y}/${m}/${d}`;
    }

    function formatDateInput(input) { input.value = formatDate(input.value); }

    function generateOutput() {
        clearAllErrors(); 

        const rows = document.querySelectorAll('.input-row');
        let dataMap = {};
        let isValid = true;
        let firstErrorRow = null;

        rows.forEach((row, index) => {
            const channel = row.querySelector('.channel').value;
            const dateApply = row.querySelector('.date-apply').value.trim();
            const item = row.querySelector('.item').value.trim();
            const dateExpiry = row.querySelector('.date-expiry').value.trim();
            const note = row.querySelector('.note').value;
            
            if (!dateApply && !item) return;
            
            let rowHasError = false;

            if (!dateApply || !item) {
                rowHasError = true;
            }
            
            let suffix = "";
            let hasExpiry = dateExpiry !== "";
            let hasNote = note !== "";

            if (hasExpiry) { 
                suffix = `(${dateExpiry})`; 
            } else if (hasNote) {
                suffix = `(${note})`;
            } else {
                rowHasError = true;
            }

            if (rowHasError) {
                row.classList.add('error-highlight');
                isValid = false;
                if (!firstErrorRow) firstErrorRow = row; 
            } else {
                const recordStr = `${dateApply}${item}${suffix}`;
                if (!dataMap[channel]) dataMap[channel] = [];
                dataMap[channel].push(recordStr);
            }
        });

        if (!isValid) {
            alert("âš ï¸ ç™¼ç¾è³‡æ–™ç¼ºæ¼ï¼å·²å°‡éŒ¯èª¤çš„è³‡æ–™æ¨™ç¤ºç‚ºç´…è‰²ã€‚\n(è«‹æª¢æŸ¥ï¼šæ—¥æœŸã€é …ç›®ã€æœ‰æ•ˆæœŸé™æˆ–å‚™è¨»æ˜¯å¦å·²å¡«)");
            if (firstErrorRow) {
                firstErrorRow.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
            return;
        }

        let finalOutput = "";
        for (const [key, list] of Object.entries(dataMap)) { finalOutput += `${key}:${list.join('ï¼›')}\n`; }
        const outputArea = document.getElementById('output');
        outputArea.value = finalOutput.trim();
        outputArea.scrollIntoView({ behavior: "smooth" });
    }

    function resetForm() {
        if(confirm("ç¢ºå®šè¦æ¸…ç©ºå—ï¼Ÿ")) {
            document.getElementById('input-container').innerHTML = ''; 
            addRow(); 
            document.getElementById('output').value = '';
            document.getElementById('paste-area').value = '';
        }
    }
</script>
</body>
</html>

